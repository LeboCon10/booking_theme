<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Technology Resource Request</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://raw.githubusercontent.com/LeboCon10/booking_theme/main/script.js"></script>
    <script src="https://raw.githubusercontent.com/LeboCon10/booking_theme/main/chartgen.js"></script>
    <style>
       .capacity-green { color: green; }
        .capacity-yellow { color: orange; }
        .capacity-red { color: red; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, rgb(22,12,54), rgb(12,12,74), rgb(151,151,151), rgb(12,12,13));
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
.week-buttons button {
    margin-right: 10px;
    margin-bottom: 10px;
}
.view-button {
    margin-right: 10px;
    margin-bottom: 10px;
}

        .container {
            text-align: center;
            padding: 113px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 73px auto;
            color: black;
            display: none;
        }

        h1, h2 { text-align: center; }

        .categories {
            display: flex;
            justify-content: center;
            gap: 40px;
            max-width: 600px;
            margin: 0 auto;
            background-color: rgba(41, 41, 61, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        .category {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
            color: white;
        }

            .category i {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2em;
            color: white;
            text-decoration: none;
        }

        .table_container {
            display: flex;
            justify-content: space-between;
        }

        .left-column, .right-column { width: 48%; }
        form {
            display: grid;
            gap: 10px;
        }

        input, select, textarea {
            margin-top: -35px;
            margin-left: 174px;
            width: 26%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        label {
            text-align: justify;
            width: 30%;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
            margin-left: 0;
        }
        button:hover { background-color: #218838; }

        table {
            width: 107%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-left: -34px;
            background-color: hsla(240, 7%, 62%, 1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: hsla(245, 44.8%, 46.9%, 0.8); }

.utilization-analyzer-container table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.utilization-analyzer-container th, 
.utilization-analyzer-container td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}


.utilization-analyzer-container th {
    background-color: #f2f2f2;
}

.utilization-analyzer-container h1 {
    font-size: 24px;
    margin-bottom: 20px;
}

.utilization-analyzer-container h3 {
    font-size: 20px;
    margin-top: 20px;
}

.grid-container-analyzer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.grid-item-analyzer {
    padding: 15px;
    border: 1px solid #ddd;
    background-color: #f9f9f9;
    border-radius: 8px;
}

        .chart-container {
            position: relative;
            width: 100%;
          height: 250px;
          margin: 10px 0;
        }

        .action-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        .action-button:hover {
            background-color: #0056b3;
        }

                .tab {
            padding: 10px 100px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: none;
        }
        .week-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .week-button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
        }

            .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .utilization-analyzer-container {
    font-family: Arial, sans-serif;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

#file-input {
  margin-top: 30px;
    margin-left: 174px;
    width: 40%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;

}

#personnel-table{
      width: 179%;
    border-collapse: collapse;
    margin-top: 20px;
    margin-left: -34px;
    background-color: hsla(240, 7%, 62%, 1);

}

.hidden-important {
    display: none !important;
}



    </style>
</head>
<body>
    <div class="container" id="home" style="display: block;">
        <h1>Learning Technology Resource Request</h1>
        <div class="categories">
            <a href="#booking-request" class="category">
                <i class="fas fa-calendar-plus"></i>
                <span>Booking Request</span>
            </a>
            <a href="#booking-data" class="category">
                <i class="fas fa-database"></i>
                <span>Booking Data</span>
            </a>
        </div>
    </div>

    <div id="booking-request" class="container">
        <a href="#home" class="home-button"><i class="fas fa-home" onclick="showContainer('home')"> home</i></a>
        <h2>Team Resource Booking System</h2>
        <div class="table_container">
            <div class="left-column">
                <form id="bookingForm">
                    <label for="project">Project:</label>
                    <select id="project">
                        <option value="">Select Project</option>
                        <option>Project A</option>
                        <option>Project B</option>
                        <option>Project C</option>
                    </select>
                    
                    <label for="requestor">Requestor:</label>
                    <input type="text" id="requestor">
                    
                    <label for="resourceType">Resource Type:</label>
                    <input type="text" id="resourceType">
                    
                    <label for="hoursPerWeek">Hours per Week:</label>
                    <input type="number" id="hoursPerWeek">
                    
                    <label for="deliveryManager">Delivery Manager:</label>
                    <input type="text" id="deliveryManager">
                    
                    <label for="startDate">Date Ready to Start:</label>
                    <input type="date" id="startDate">
                    
                    <label for="deadline">Deadline:</label>
                    <input type="date" id="deadline">
                    
                    <label for="preferredLT">Preferred LT:</label>
                    <select id="preferredLT">
                        <option value="">Select LT</option>
                        <option>LT1</option>
                        <option>LT2</option>
                        <option>LT3</option>
                        <option>LT4</option>
                    </select>
                    
                    <label for="linkText">Text for Link:</label>
                    <input type="text" id="linkText">
                    
                    <label for="linkUrl">Insert Link:</label>
                    <input type="url" id="linkUrl">
                    
                    <button type="button" onclick="insertLink()" style="width: 20%; margin-top: -46px; margin-left: 360px; margin-bottom: 9px;">Add Link</button>
                    <input type="hidden" id="projectLinks">
                    
                    <label for="communicationNotes">Communication Notes:</label>
                    <textarea id="communicationNotes" style="width: 382px; height: 162px;"></textarea>
                                        <label>Booked In?</label>
                    <div style="margin-right: 390px;margin-top: -29px;">
                        <label><input type="radio" name="bookedIn" value="Yes" style="margin-left:59px;">Yes</label>
                        <label><input type="radio" name="bookedIn" value="No" style="margin-left: 55px;">No</label>
                    </div>

                    <button type="submit">Book</button>
                </form>
            </div>
            <div class="right-column">
                <div id="ltCapacity">
                    <h3>LT Capacity</h3>
                    <table id="capacityTable">
                      <tbody>
                                                <tr>
                            <th>LT</th>
                            <th>Total Capacity (hours)</th>
                            <th>Remaining Capacity (hours)</th>
                        </tr>
                        <tr>
                                <td id="LT1-name">LT1</td>
                                <td id="total-LT1">0</td>
                                <td id="remaining-LT1" class="capacity-green">40</td>
                            </tr>
                            <tr>
                                <td id="LT2-name">LT2</td>
                                <td id="total-LT2">0</td>
                                <td id="remaining-LT2" class="capacity-green">40</td>
                            </tr>
                            <tr>
                                <td id="LT3-name">LT3</td>
                                <td id="total-LT3">0</td>
                                <td id="remaining-LT3" class="capacity-green">40</td>
                            </tr>
                            <tr>
                                <td id="LT4-name">LT4</td>
                                <td id="total-LT4">0</td>
                                <td id="remaining-LT4" class="capacity-green">40</td>
                        </tr>
                      </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div id="booking-data" class="container" style="display: none;">
        <a href="#home" class="home-button"  onclick="showContainer('home')"><i class="fas fa-home"> home</i></a>
        <h2>Bookings</h2>
        <button class="view-button" onclick="viewBookingData('bookingDataContainer')">View Booking Data</button>
        <button class="view-button" onclick="viewWeeklyData('weeklyDataContainer')">View Weekly Data</button>
        <button class="view-button" onclick="viewAnalyzerData('analyzerContainer')">View Analyzer Data</button>
        
        <div id="bookingDataContainer" style="display: none;">
                <div id="bookingData" style="margin-top: 20px;">
            <table id="bookingTable">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Requestor</th>
                        <th>Resource Type</th>
                        <th>Hours per Week</th>
                        <th>Delivery Manager</th>
                        <th>Start Date</th>
                        <th>Deadline</th>
                        <th>Preferred LT</th>
                        <th>Project Links</th>
                        <th>Communication Notes</th>
                        <th>Booked In</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Booking data will be inserted here -->
                </tbody>
            </table>
        </div>
      </div>

        <div id="weeklyDataContainer" style="display: none;">
            <h3>Weekly LT Bookings</h3>
            <select id="monthSelector" onchange="updateWeeklyData()" style="margin-left: -2px;"></select>
            <div id="weekButtonsContainer" class="week-buttons"></div>
            <canvas id="weeklyChart"></canvas>
        </div>


        <div id="analyzerContainer" class="grid-container-analyzer" style="display: none;">
              <h1>Utilization and Personnel Analyzer</h1>
              <input type="file" id="file-input" accept=".csv">

        <div class="grid-item-analyzer">
            <h3>Scheduled Utilization</h3>
            <div class="chart-container">
                <canvas id="scheduled-utilization-chart"></canvas>
            </div>
            <p id="scheduled-utilization-details"></p>
        </div>

        <div class="grid-item-analyzer">
            <h3>Actual Utilization</h3>
            <div class="chart-container">
                <canvas id="actual-utilization-chart"></canvas>
            </div>
            <p id="actual-utilization-details"></p>
        </div>

        <div class="grid-item-analyzer">
            <h3>Projects</h3>
            <p id="projects-count"></p>
        </div>

        <div class="grid-item-analyzer">
            <h3>Personnel</h3>
            <p id="personnel-count"></p>
        </div>

            <table id="personnel-table">
        <thead>
            <tr>
                <th>Personnel</th>
                <th>Holiday</th>
                <th>Time Off</th>
                <th>Capacity</th>
                <th>Scheduled</th>
                <th>Actual</th>
                <th>Variance</th>
                <th>Scheduled</th>
                <th>Actual</th>
                <th>Variance</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
        </div>

    </div>

    <script>

          // Switch to a different section
    document.querySelectorAll('.category, .home-button').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'none';
            });
            document.getElementById(targetId).style.display = 'block';
        });
    });

    // Handle form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bookingForm');
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const project = document.getElementById('project').value;
        const requestor = document.getElementById('requestor').value;
        const resourceType = document.getElementById('resourceType').value;
        const hoursPerWeek = parseInt(document.getElementById('hoursPerWeek').value);
        const deliveryManager = document.getElementById('deliveryManager').value;
        const startDate = document.getElementById('startDate').value;
        const deadline = document.getElementById('deadline').value;
        const preferredLT = document.getElementById('preferredLT').value;
        const communicationNotes = document.getElementById('communicationNotes').value;
        const bookedIn = document.querySelector('input[name="bookedIn"]:checked');

        // Validate that all required fields are filled in
        if (project && requestor && resourceType && hoursPerWeek && deliveryManager && startDate && deadline && preferredLT && bookedIn) {
            // Check remaining capacity and proceed only if there's enough capacity
            const remainingCapacity = getRemainingCapacity(preferredLT);
            if (remainingCapacity >= hoursPerWeek) {
                updateLTCapacity(preferredLT, hoursPerWeek);

                // Calculate the week number and month based on the start date
                const bookingDate = new Date(startDate);
                const currentWeek = getCurrentWeekNumber(bookingDate);
                const currentMonth = bookingDate.toLocaleString('default', { month: 'long' });

                // Store the booking data in the backend
                fetch('/api/bookings/store', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        week: currentWeek,
                        month: currentMonth,
                        booking: {
                            project,
                            requestor,
                            resourceType,
                            hours: hoursPerWeek,
                            deliveryManager,
                            startDate,
                            deadline,
                            preferredLT,
                            projectLinks: document.getElementById('projectLinks').value,
                            communicationNotes,
                            bookedIn: bookedIn.value === 'Yes'
                        }
                    })
                })
                .then(response => {
                    if (response.ok) {
                        alert('Booking successful!');
                        form.reset();
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || response.statusText);
                        });
                    }
                })
                .catch(error => {
                    alert('Error storing booking: ' + error.message);
                });

                // Call the `addBooking` function after the fetch operation
                addBooking(
                    project,
                    requestor,
                    resourceType,
                    hoursPerWeek,
                    deliveryManager,
                    startDate,
                    deadline,
                    preferredLT,
                    '', // If you have any value for this parameter, replace the empty string
                    communicationNotes,
                    bookedIn.value
                );
            } else {
                alert('Not enough capacity for this booking.');
            }
        } else {
            alert('Please fill in all required fields.');
        }
    });
});


// Function to get the current week number
function getCurrentWeekNumber(date) {
    const startOfYear = new Date(date.getFullYear(), 0, 1);
    const weekNumber = Math.ceil((((date - startOfYear) / 86400000) + startOfYear.getDay() + 1) / 7);
    return weekNumber;
}

  // Handles link submission for form
    function insertLink() {
        const linkText = document.getElementById('linkText').value;
        const linkUrl = document.getElementById('linkUrl').value;
        if (linkText && linkUrl) {
            const currentLinks = document.getElementById('projectLinks').value;
            const newLink = `<a href="${linkUrl}">${linkText}</a>`;
            if (document.getElementById('projectLinks')) {
                document.getElementById('projectLinks').value = currentLinks ? `${currentLinks}, ${newLink}` : newLink;
            } else {
                document.getElementById('bookingForm').appendChild(hiddenInput);
            }
            document.getElementById('linkText').value = '';
            document.getElementById('linkUrl').value = '';
        }
    }


 // calaculates remaining capacity for LT's
    function getRemainingCapacity(preferredLT) {
        const row = document.querySelector(`#capacityTable tr:nth-child(${['LT1', 'LT2', 'LT3', 'LT4'].indexOf(preferredLT) + 2})`);
        const remainingCapacityCell = row.cells[2];
        return parseInt(remainingCapacityCell.textContent);
    }


   // updates capacity for LT's after booking
        function updateLTCapacity(preferredLT, bookedHours) {
            const totalCapacityCell = document.getElementById(`total-${preferredLT}`);
            const remainingCapacityCell = document.getElementById(`remaining-${preferredLT}`);
            const totalCapacity = parseInt(totalCapacityCell.textContent) + bookedHours;
            const remainingCapacity = parseInt(remainingCapacityCell.textContent) - bookedHours;

            totalCapacityCell.textContent = totalCapacity;
            remainingCapacityCell.textContent = remainingCapacity;

            if (remainingCapacity <= 0) {
                remainingCapacityCell.className = 'capacity-red';
            } else if (remainingCapacity <= 20) {
                remainingCapacityCell.className = 'capacity-yellow';
            } else {
                remainingCapacityCell.className = 'capacity-green';
            }
        }

        function hideAllDataContainers() {
            document.getElementById('bookingDataContainer').style.display = 'none';
            document.getElementById('weeklyDataContainer').style.display = 'none';
            document.getElementById('analyzerContainer').style.display = 'none';
        }

function viewBookingData(containerId) {
  hideAllDataContainers();
   document.getElementById(containerId).style.display = 'block';
    
    // Clear any existing data in the table
    const tableBody = document.getElementById('bookingTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = '';
    
    // Define the date object before using it
    const date = new Date();
    
    // Dynamically calculate the current week number and month
    const currentWeek = getCurrentWeekNumber(date);
    const currentMonth = date.toLocaleString('default', { month: 'long' });
    
    // Make an AJAX request to retrieve the booking data for the current week and month
    fetch(`/api/bookings/view-booking-data?week=${currentWeek}&month=${currentMonth}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error retrieving booking data: ' + response.status + ' - ' + response.statusText);
            }
            return response.json();
        })
        .then(bookings => {
            // Loop through the bookings and add them to the table
            bookings.forEach(booking => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = booking.project;
                row.insertCell(1).textContent = booking.requestor;
                row.insertCell(2).textContent = booking.resourceType;
                row.insertCell(3).textContent = booking.hours;
                row.insertCell(4).textContent = booking.deliveryManager;
                row.insertCell(5).textContent = booking.startDate;
                row.insertCell(6).textContent = booking.deadline;
                row.insertCell(7).textContent = booking.preferredLT;
                row.insertCell(8).innerHTML = booking.projectLinks || '';
                row.insertCell(9).textContent = booking.communicationNotes;
                row.insertCell(10).textContent = booking.bookedIn ? 'Yes' : 'No';
            });
        })
        .catch(error => {
            console.error('Error retrieving booking data:', error);
            alert(error.message);
        });
}


        function viewWeeklyData(containerId) {
          hideAllDataContainers();
          document.getElementById(containerId).style.display = 'block'; 

                if (window.weeklyChart) {
            window.weeklyChart.destroy();
        }
        renderChart('weeklyChart', 'bar', getWeeklyData());

        }

        function viewAnalyzerData(containerId) {
          hideAllDataContainers();
            document.getElementById(containerId).style.display = 'grid';
        }

// Function to get the name of the current month
function getCurrentMonthName() {
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const now = new Date();
    return months[now.getMonth()];
}

// Function to get the weeks of the current month
function getWeeksOfCurrentMonth() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const weeks = [];

    // Get the first day of the month
    const firstDay = new Date(currentYear, currentMonth, 1);
    
    // Get the last day of the month
    const lastDay = new Date(currentYear, currentMonth + 1, 0);

    // Get the week number of the first day
    let weekNumber = getWeekNumber(firstDay);

    // Loop through the days and collect unique week numbers
    for (let d = firstDay; d <= lastDay; d.setDate(d.getDate() + 1)) {
        const weekNum = getWeekNumber(d);
        if (!weeks.includes(weekNum)) {
            weeks.push(weekNum);
        }
    }

    return weeks;
}

// Helper function to get week number
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// Function to generate week buttons and display current month
function generateWeekButtonsAndMonth() {
    const currentMonth = getCurrentMonthName();
    document.getElementById('currentMonth').textContent = currentMonth;

    const weeks = getWeeksOfCurrentMonth();
    const weekButtonsContainer = document.getElementById('weekButtons');
    weekButtonsContainer.innerHTML = '';

    weeks.forEach(week => {
        const button = document.createElement('button');
        button.className = 'week-button';
        button.textContent = `Week ${week}`;
        button.onclick = () => updateWeeklyData(week);
        weekButtonsContainer.appendChild(button);
    });
}


function renderChart(canvasId, chartType, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    window[canvasId] = new Chart(ctx, {
        type: chartType,
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return `${tooltipItem.label}: ${tooltipItem.raw}`;
                        }
                    }
                }
            }
        }
    });
}

// Function to process booking data
function processBookingData(bookings) {
    const ltData = {};

    bookings.forEach(booking => {
        const lt = booking.preferredLT;
        if (!ltData[lt]) {
            ltData[lt] = 0;
        }
        ltData[lt] += booking.hours;
    });

    const labels = Object.keys(ltData);
    const data = Object.values(ltData);

    return {
        labels: labels,
        datasets: [{
            label: 'LTs Hours (out of 40)',
            data: data,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
        }]
    };
}

document.addEventListener('DOMContentLoaded', function() {
    const weekButtonsContainer = document.getElementById('weekButtonsContainer');
    generateWeekButtons();

    function generateWeekButtons() {
        const today = new Date();
        const month = today.toLocaleString('default', { month: 'short' });
        const currentWeek = getWeekNumber(today);

        // Adjust the number of weeks you want to display (e.g., 4 weeks)
        for (let i = currentWeek - 3; i <= currentWeek; i++) {
            const weekButton = document.createElement('button');
            weekButton.className = 'week-button';
            weekButton.textContent = `Week ${i}`;
            weekButton.onclick = function() {
                updateWeeklyData(i);
            };
            weekButtonsContainer.appendChild(weekButton);
        }
    }

    function getWeekNumber(date) {
        // Returns the ISO week number
        const firstJan = new Date(date.getFullYear(), 0, 1);
        const daysSinceFirstJan = Math.floor((date - firstJan) / (24 * 60 * 60 * 1000));
        const weekNumber = Math.ceil((daysSinceFirstJan + firstJan.getDay() + 1) / 7);
        return weekNumber;
    }



    function updateChart(hoursData) {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['LT 1', 'LT 2', 'LT 3', 'LT 4'],
                datasets: [{
                    label: 'Hours Resourced',
                    data: hoursData,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});

let weeklyChart = null;

        function populateMonthSelector() {
            const monthSelector = document.getElementById('monthSelector');
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelector.appendChild(option);
            });
        }

        async function viewWeeklyData() {
            const weeklyDataContainer = document.getElementById('weeklyDataContainer');
            weeklyDataContainer.style.display = 'block';
            bookingDataContainer.style.display = 'none';
            analyzerContainer.style.display = 'none';
            
            try {
                const response = await fetch('/api/bookings/view-weekly-data');
                const data = await response.json();
                
                populateMonthSelector();
                updateWeeklyData();
            } catch (error) {
                console.error('Error fetching weekly data:', error);
            }
        }

        function showContainer(containerId) {
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'none';
            });
            document.getElementById(containerId).style.display = 'block';
        }


                async function updateWeeklyData() {
            const monthSelector = document.getElementById('monthSelector');
            const selectedMonth = monthSelector.value;
            
            try {
                const response = await fetch('/api/bookings/view-weekly-data');
                const allData = await response.json();
                const monthData = allData.filter(week => week.month === selectedMonth);
                
                updateWeekButtons(monthData);
                updateWeeklyChart(monthData);
            } catch (error) {
                console.error('Error updating weekly data:', error);
            }
        }

               function updateWeekButtons(data) {
            const weekButtonsContainer = document.getElementById('weekButtonsContainer');
            weekButtonsContainer.innerHTML = '';
            
            data.forEach(week => {
                const button = document.createElement('button');
                button.textContent = `Week ${week.week}`;
                button.onclick = () => updateWeeklyChart([week]);
                weekButtonsContainer.appendChild(button);
            });
        }
        
          function updateWeeklyChart(data) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['LT1', 'LT2', 'LT3', 'LT4'],
                    datasets: data.map(week => ({
                        label: `Week ${week.week}`,
                        data: [week.ltHours.LT1, week.ltHours.LT2, week.ltHours.LT3, week.ltHours.LT4],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }))
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40
                        }
                    }
                }
            });
        }       

        // Initialize the page

document.querySelectorAll('.category').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Use closest to ensure you're working with the correct <a> element
        const anchor = e.target.closest('a');
        
        if (anchor && anchor.getAttribute('href')) {
            const targetId = anchor.getAttribute('href').substr(1);
            showContainer(targetId);
        } else {
            console.error('Anchor href is missing or null.');
        }
    });
});


        document.querySelectorAll('.home-button').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showContainer('home');
            });
        });

        
// Analyzer javascript code below here

        const fileInput = document.getElementById('file-input');
        let data = [];

        fileInput.addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    data = results.data;
                    processData();
                    updateUI();
                }
            });
        }

        function processData() {
            // Calculate total capacity and scheduled hours
            const totalCapacity = data.reduce((sum, row) => sum + row.Capacity, 0);
            const totalScheduled = data.reduce((sum, row) => sum + row.Scheduled, 0);
            const totalActual = data.reduce((sum, row) => sum + row.Actual, 0);

            // Calculate utilization percentages
            window.scheduledUtilization = (totalScheduled / totalCapacity) * 100;
            window.actualUtilization = (totalActual / totalCapacity) * 100;

            // Calculate available hours
            window.availableScheduledHrs = totalCapacity - totalScheduled;
            window.availableActualHrs = totalCapacity - totalActual;

            // Count unique personnel
            window.personnelCount = new Set(data.map(row => row.Personnel)).size;

            // For this example, we'll set a fixed number of projects
            window.projectsCount = 16;
        }

        function updateUI() {
            updateUtilizationCharts();
            updateProjectsAndPersonnel();
            updatePersonnelTable();
        }

        function updateUtilizationCharts() {
            createDoughnutChart('scheduled-utilization-chart', window.scheduledUtilization, 'Scheduled Utilization');
            document.getElementById('scheduled-utilization-details').innerHTML = 
                `Available Hrs: ${window.availableScheduledHrs}<br>Sched Hrs: ${data.reduce((sum, row) => sum + row.Scheduled, 0)}<br>Possible Hrs: ${data.reduce((sum, row) => sum + row.Capacity, 0)}`;

            createDoughnutChart('actual-utilization-chart', window.actualUtilization, 'Actual Utilization');
            document.getElementById('actual-utilization-details').innerHTML = 
                `Available Hrs: ${window.availableActualHrs}<br>Actual Hrs: ${data.reduce((sum, row) => sum + row.Actual, 0)}<br>Possible Hrs: ${data.reduce((sum, row) => sum + row.Capacity, 0)}`;
        }

        function createDoughnutChart(canvasId, percentage, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: ['#4CAF50', '#E0E0E0']
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
            
            // Add percentage text in the center
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#000';
            ctx.fillText(`${percentage.toFixed(1)}%`, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        function updateProjectsAndPersonnel() {
            document.getElementById('projects-count').textContent = window.projectsCount;
            document.getElementById('personnel-count').textContent = window.personnelCount;
        }

        function updatePersonnelTable() {
            const tableBody = document.querySelector('#personnel-table tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            data.forEach(person => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><img src="/api/placeholder/30/30" alt="${person.Personnel}" class="avatar">${person.Personnel}</td>
                    <td>${person.Holiday}h</td>
                    <td>${person.TimeOff}h</td>
                    <td>${person.Capacity}h</td>
                    <td>${person.Scheduled}h</td>
                    <td>${person.Actual}h</td>
                    <td>${calculateVariance(person.Scheduled, person.Actual)}</td>
                    <td>${person.Billable}h</td>
                    <td>${person.Actual}h</td>
                    <td>${calculateVariance(person.Billable, person.Actual)}</td>
                `;
            });
        }

        function calculateVariance(scheduled, actual) {
            const variance = actual - scheduled;
            return variance >= 0 ? `${variance}h` : `-${Math.abs(variance)}h`;
        }
    </script>
</body>
</html>